<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Ubuntu迁移Home文件夹到新分区 | Licheng Wen</title> <meta name="author" content="Licheng Wen"> <meta name="description" content="Personal website of Licheng Wen, a researcher in the field of autonomous driving and multi-agent systems. "> <meta name="keywords" content="wen licheng, licheng, jekyll, academic-website, personal website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%A8%E2%80%8D%F0%9F%92%BB&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://wenlc.cn/blog/2020/move-home/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Licheng </span>Wen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" target="_blank" href="/assets/pdf/LichengWen_resume.pdf">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Ubuntu迁移Home文件夹到新分区</h1> <p class="post-meta">August 14, 2020</p> <p class="post-tags"> <a href="/blog/2020"> <i class="fas fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/ubuntu"> <i class="fas fa-hashtag fa-sm"></i> ubuntu</a>   <a href="/blog/tag/shell"> <i class="fas fa-hashtag fa-sm"></i> shell</a>   <a href="/blog/tag/file-system"> <i class="fas fa-hashtag fa-sm"></i> File system</a>   <a href="/blog/tag/%E6%95%99%E7%A8%8B"> <i class="fas fa-hashtag fa-sm"></i> 教程</a>     ·   <a href="/blog/category/%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0"> <i class="fas fa-tag fa-sm"></i> 知识学习</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>由于home文件夹较大,且其默认是在系统盘下的. 当系统盘空间不足时,我们可以将Home文件夹移至新磁盘下的新分区内.</p> <h1 id="overview">Overview</h1> <p>This guide offers detailed instructions for migrating your home directory into its own dedicated partition. Setting up /home on a separate partition is beneficial because your settings, files, and desktop will be maintained if you upgrade, (re)install Ubuntu or another distro. This works because /home has a subdirectory for each user’s settings and files which contain all the data &amp; settings of that user. Telling Ubuntu to use an existing home partition can be done by selecting “Manual Partitioning” during the installation of Ubuntu and specifying that you want your home partitions mount point to be /home, <strong>ensure you mark your /home partition not be formatted in the process</strong>. You should also make sure the usernames you enter for accounts during installation match usernames that existed in a previous installation.</p> <p>This guide will follow these 8 basic steps:</p> <ol> <li>Set-up your new partition</li> <li>Find the uuid (=address) of the new partition</li> <li>Backup and edit your fstab to mount the new partition as /media/home (just for the time being) and reboot.</li> <li>Use rsync to migrate all data from /home into /media/home</li> <li>Check copying worked!</li> <li>Move /home to /old_home to avoid confusion later!</li> <li>Edit fstab again so the new partition mounts as /home instead of as /media/home</li> <li>Reboot or remount all. Check system seems to be working well</li> <li>Delete the /old_home after a while</li> </ol> <p>The guide is written in such a way so that at any point in time if there is a system failure, power outage or random restart that it will not have a negative impact on the system and <em>SHOULD</em> safeguard against the possibility of the user accidentally deleting their home directory in the process.</p> <h1 id="creating-a-new-partition">Creating a new partition</h1> <p>Setting up /home on a separate partition is beneficial because your settings, files, and desktop will be maintained if you upgrade, (re)install Ubuntu or another distro. This works because /home has a subdirectory for each user’s settings and files which contain all the data &amp; settings of that user. Also, fresh installs for linux typically like to wipe whatever partition they are being installed to so either the data &amp; settings need to be backed-up elsewhere or else avoid the fuss each time by having /home on a different partition.</p> <h2 id="setup-partitions">Setup Partitions</h2> <p>建立新分区可以使用gparted,可视化软件.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install gparted
</code></pre></div></div> <p>This is beyond the scope of this page. <a href="https://help.ubuntu.com/community/HowtoPartition" rel="external nofollow noopener" target="_blank">Try here if you need help</a>. Memorize or write down the location of the partition, something like /sda3. When you do <strong>create a new partition it is highly suggested that you create an ext3 or ext4 partition</strong> to house your new home directory.</p> <h2 id="find-the-uuid-of-the-partition">Find the uuid of the Partition</h2> <p>The uuid (Universally Unique Identifier) reference for all partitions can be found by opening a <a href="https://help.ubuntu.com/community/UsingTheTerminal#Starting%20a%20Terminal" rel="external nofollow noopener" target="_blank">command-line</a> to type the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo blkid
</code></pre></div></div> <h3 id="alternative-method">Alternative Method</h3> <p>For some older releases of Ubuntu the “blkid” command might not work so this could be used instead</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vol_id -u &lt;partition&gt;
</code></pre></div></div> <p>for example</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vol_id -u /dev/sda3
</code></pre></div></div> <p>Now you just need to take note (copy&amp;paste into a text-file) the uuid of the partition that you have set-up ready to be the new /home partition.</p> <h1 id="setup-fstab">Setup Fstab</h1> <p>Your fstab is a file used to tell Ubuntu what partitions to mount at boot. The following commands will duplicate your current fstab, append the year-month-day to the end of the file name, compare the two files and open the original for editing.</p> <ol> <li>Duplicate your fstab file:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo cp /etc/fstab /etc/fstab.$(date +%Y-%m-%d)
</code></pre></div></div> <ol> <li>Compare the two files to confirm the backup matches the original:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmp /etc/fstab /etc/fstab.$(date +%Y-%m-%d)
</code></pre></div></div> <ol> <li>Open the original fstab in a text editor:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo gedit /etc/fstab 
</code></pre></div></div> <p>and add these lines into it</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># (identifier)  (location, eg sda5)   (format, eg ext3 or ext4)      (some settings) 
UUID=????????   /media/home    ext3          defaults       0       2 
</code></pre></div></div> <p>and replace the “????????” with the UUID number of the intended /home partition.</p> <p>NOTE: In the above example, the specified partition in the new text is an ext3, but if yours is an ext4 partition, you should change the part above that says “ext3” to say “ext4”, in addition to replacing the ???’s with the correct UUID. Also note that if you are using Kubuntu, Xubuntu or Lubuntu you may need to replace “gedit” with “kate”, “mousepad” or “leafpad”, respectively. They are text editors included with those distributions.</p> <ol> <li>Save and Close the fstab file, then type the following command:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mkdir /media/home
</code></pre></div></div> <p>This command will create a new directory, later used for temporarily mounting the new partition. At the end of the procedure this directory can be removed.</p> <p>Now you can restart your machine or instead of rebooting you might prefer to just re-load the updated fstab</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mount -a
</code></pre></div></div> <p>Either should have mounted the new partition as /media/home. We will edit the fstab again later so this arrangement of the partition is only temporary.</p> <h1 id="copy-home-to-the-new-partition">Copy /home to the New Partition</h1> <p>Next we will copy all files, directories and sub-directories from your current /home directory into the new partition. If you do not have an encrypted home file system, just do the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo rsync -aXS --exclude='/*/.gvfs' /home/. /media/home/.
</code></pre></div></div> <p>I prefer adding the “–progress” tag just before the “–excludes” one - otherwise there is no indication of anything happening. The “–progress” tag reports on each file individually so you see tons of unfamiliar stuff scrolling by very fast. Rsync can be interrupted as many times as you like and it checks to see how much has already been done when you start it up again. So, this copying stage can be broken down into many sessions. After it has completed once it’s wise to run it a couple more times just to make sure it includes everything you may have added since first starting the first copying/syncing session - even if you’ve done the whole thing all in just one session.</p> <p>The –exclude=’/*/.gvfs’ prevents rsync from complaining about not being able to copy .gvfs, but I believe it is optional. Even if rsync complains, it will copy everything else anyway. (<a href="http://ubuntuforums.org/showthread.php?t=791693" rel="external nofollow noopener" target="_blank">See here for discussion on this</a>)</p> <h2 id="encrypted-file-systems">Encrypted file systems</h2> <p>If you have an encrypted home file system, then the above will just leave you with an unencrypted copy of your files, which is probably not what you want. You could re-encrypt them after copying, or copy them in their encrypted form. Here is one way to do that.</p> <p>First, you’ll need to shut down, and reboot from a LiveCD or USB stick. Then you’ll need to mount your root partition and new home partition. (You can do this by selecting those devices in the file viewer). They will be mounted under /media/ubuntu - so for example, if you named your root partition linux-root, then your old home directory will be found at /media/ubuntu/linux-root/home. And if you named your new home partition linux-home, then this will be found at /media/ubuntu/linux-home. So, now you can copy your encrypted home files (here assuming your partitions are named linux-root and linux-home):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo rsync -aXS /media/ubuntu/linux-root/home/. /media/ubuntu/linux-home/.
</code></pre></div></div> <p>There is no point trying to exclude any files with specific names, because the names of the files are encrypted too!</p> <p>Leave your machine running from the LiveCD or USB for the moment.</p> <h1 id="optional-check-copying-worked">Optional: Check Copying Worked</h1> <p>You should now have two duplicate copies of all the data within your home directory; the original being located in /home and the new duplicate located in /media/home. You should confirm all files and directories copied over successfully. One way to do this (for an unencrypted file system) is by using the diff command:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo diff -r /home /media/home -x ".gvfs/*"
</code></pre></div></div> <p>If you are doing this from a <a href="https://help.ubuntu.com/community/LiveCd" rel="external nofollow noopener" target="_blank">LiveCd</a> or to an existing partition that already has stuff on it you may find differences but hopefully it should be obvious which diffs you can ignore.</p> <p>You can also expect to see some errors about files not found. These are due to symbolic links that point to places that don’t presently exist (but will do after you have rebooted). You can ignore these - but check out anything else.</p> <h2 id="encrypted-file-systems-1">Encrypted file systems</h2> <p>If you have an encrypted file system, the command will look more like this.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo diff -r /media/ubuntu/linux-root/home /media/ubuntu/linux-home
</code></pre></div></div> <p>Now you can shut-down, remove the LiveCD / USB stick, and reboot as normal.</p> <h1 id="preparing-fstab-for-the-switch">Preparing fstab for the switch</h1> <p>We now need to modify the fstab again to point to the new partition and mount it as /home. So again on a command-line</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo gedit /etc/fstab
</code></pre></div></div> <p>and now edit the lines you added earlier, changing the “/media/home” part to simply say “/home” so that it looks like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># (identifier)  (location, eg sda5)   (format, eg ext3 or ext4)      (some settings) 
UUID=????????   /home    ext3          defaults       0       2
</code></pre></div></div> <p>Then, press Save, close the file but don’t reboot just yet.</p> <h1 id="moving-home-into-old_home">Moving /home into /old_home</h1> <p>Backing up your old home, just in case things have not gone completely smoothly, is best done right now. Here is how:</p> <p>As long as you have not rebooted yet, you will still see 2 copies of your /home directory; the new one on the new partition (currently mounted as /media/home) and the old one still in the same partition it was always in (currently mounted as /home). We need to move the contents of the old home directory out of the way and create an empty “place-holder” directory to act as a “mount point” for our new partition.</p> <p>Type the following string of commands in to do all this at once:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd / &amp;&amp; sudo mv /home /old_home &amp;&amp; sudo mkdir /home
</code></pre></div></div> <p>By default, when you open a terminal window it places you within your home directory. Typing cd / takes us to the root directory and out of home so we can then use the sudo mv command to essentially rename /home into /old_home, and finally create a new, empty /home placeholder.</p> <h1 id="reboot-or-remount-all">Reboot or Remount all</h1> <p>With;</p> <ol> <li>your fstab now edited to mount your new partition to our /home place-holder and</li> <li>the original /home now called /old_home,</li> </ol> <p>it should be a good time to reboot your computer to check the whole thing really did work. Your new partition should mount as /home and everything should look exactly the same as it did before you started.</p> <p>Btw, geeks might prefer to avoid rebooting by just re-loading the updated fstab</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mount -a
</code></pre></div></div> <p>There is no need to reboot - unless you have an encrypted file system.</p> <h2 id="troubleshooting">Troubleshooting</h2> <p>If you receive an error like ‘The volume may already be mounted’, use the following command to unmount the drive first before re-doing the last step again. (note the “n” should be missing from the command, making it “umount”)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo umount /media/home/
</code></pre></div></div> <p>Then try mounting again</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mount -a
</code></pre></div></div> <h1 id="deleting-the-old-home">Deleting the old Home</h1> <p>You can keep using the system as it is for ages before doing this, unless you are desperately short of space on the / partition. It’s probably best to leave this step until a long time after you have been using the system happily. When you do eventually feel safe enough to delete the old home then you can try;</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /
sudo rm -rI /old_home
</code></pre></div></div> <p>Be careful with the above command because mis-typing it could result in the deletion of other files and directories!</p> <h1 id="technical-notes-and-resources">Technical Notes and Resources</h1> <table> <tbody> <tr> <td>Rsync was chosen over cp and find</td> <td>cpio because it seemed to maintain permissions.</td> </tr> </tbody> </table> <p>http://ubuntu.wordpress.com/2006/01/29/move-home-to-its-own-partition/</p> <p>http://ubuntuforums.org/showthread.php?t=46866</p> </div> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © Copyright 2023 Licheng Wen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme.Last updated: July 28, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SE6TFLVDZE"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-SE6TFLVDZE");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>